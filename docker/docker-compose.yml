version: '3.8'  # å…¼å®¹Docker 20.10+ï¼Œæ”¯æŒGPUèµ„æºé…ç½®

# è‡ªå®šä¹‰ç½‘ç»œï¼šéš”ç¦»å®¹å™¨ï¼Œæå‡å®‰å…¨æ€§å’Œç½‘ç»œç¨³å®šæ€§
networks:
  lazyllm-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.28.0.0/16  # è‡ªå®šä¹‰å­ç½‘ï¼Œé¿å…å’Œå…¶ä»–å®¹å™¨å†²çª

services:
  # 1. Redisç¼“å­˜æœåŠ¡ï¼ˆç”Ÿäº§çº§é…ç½®ï¼šAOFæŒä¹…åŒ–+å¥åº·æ£€æŸ¥ï¼‰
  redis:
    image: redis:7.2-alpine  # è½»é‡ç‰ˆæœ¬ï¼Œé•œåƒå¤§å°ä»…5MBå·¦å³
    container_name: lazyllm-redis
    ports:
      - "6379:6379"  # ç«¯å£æ˜ å°„ï¼ˆä¸»æœº:å®¹å™¨ï¼‰
    volumes:
      - ./redis/data:/data  # æ•°æ®æŒä¹…åŒ–ç›®å½•ï¼ˆæŒ‚è½½åˆ°ä¸»æœºï¼‰
      - ./redis/redis.conf:/etc/redis/redis.conf  # è‡ªå®šä¹‰é…ç½®æ–‡ä»¶
    restart: always  # å®¹å™¨é€€å‡ºè‡ªåŠ¨é‡å¯ï¼ˆé«˜å¯ç”¨ä¿éšœï¼‰
    command: redis-server /etc/redis/redis.conf  # åŠ è½½è‡ªå®šä¹‰é…ç½®
    networks:
      - lazyllm-network
    healthcheck:  # å¥åº·æ£€æŸ¥ï¼šç¡®ä¿Rediså°±ç»ªåå†å¯åŠ¨å…¶ä»–æœåŠ¡
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s  # æ£€æŸ¥é—´éš”
      timeout: 5s    # è¶…æ—¶æ—¶é—´
      retries: 3     # é‡è¯•æ¬¡æ•°ï¼ˆå¤±è´¥åˆ™æ ‡è®°ä¸ºä¸å¥åº·ï¼‰
    environment:
      - TZ=Asia/Shanghai  # æ—¶åŒºé…ç½®ï¼ˆå’Œä¸»æœºä¸€è‡´ï¼‰

  # 2. RAGåº”ç”¨æœåŠ¡ï¼ˆæ ¸å¿ƒæœåŠ¡ï¼šFastAPI+LazyLLM+GPUåŠ é€Ÿï¼‰
  rag-app:
    build:
      context: ../  # æ„å»ºä¸Šä¸‹æ–‡ï¼šé¡¹ç›®æ ¹ç›®å½•ï¼ˆç¡®ä¿èƒ½è®¿é—®api/ã€rag/ç­‰ç›®å½•ï¼‰
      dockerfile: docker/Dockerfile  # Dockerfileè·¯å¾„
    container_name: lazyllm-rag-app
    ports:
      - "8000:8000"  # FastAPIæ¥å£ç«¯å£
    volumes:
      - ../vector_db:/app/vector_db  # å‘é‡æ•°æ®åº“æŒä¹…åŒ–
      - ../multimodal_vector_db:/app/multimodal_vector_db  # å¤šæ¨¡æ€å‘é‡åº“
      - ../models:/app/models  # æ¨¡å‹ç›®å½•æŒ‚è½½ï¼ˆé¿å…é‡å¤ä¸‹è½½ï¼‰
      - ../data:/app/data  # æ•°æ®ç›®å½•æŒ‚è½½ï¼ˆç”¨æˆ·å¯æ›¿æ¢ä¸ºå®é™…æ•°æ®ï¼‰
      - ../logs:/app/logs  # æ—¥å¿—ç›®å½•æŒ‚è½½ï¼ˆæ–¹ä¾¿æ’æŸ¥é—®é¢˜ï¼‰
    depends_on:
      redis:
        condition: service_healthy  # ä¾èµ–Rediså¥åº·çŠ¶æ€
    restart: always  # åº”ç”¨å´©æºƒè‡ªåŠ¨é‡å¯
    environment:
      - REDIS_URL=redis://redis:6379/0  # Redisè¿æ¥åœ°å€ï¼ˆå®¹å™¨åä½œä¸ºhostnameï¼‰
      - PYTHONPATH=/app  # Pythonè·¯å¾„é…ç½®ï¼ˆç¡®ä¿èƒ½å¯¼å…¥api/ã€rag/æ¨¡å—ï¼‰
      - CUDA_VISIBLE_DEVICES=0  # æŒ‡å®šGPUå¡å·ï¼ˆå¤šGPUå¯æ”¹ä¸º"0,1"ï¼‰
      - LOG_LEVEL=INFO  # æ—¥å¿—çº§åˆ«ï¼šINFOï¼ˆç”Ÿäº§ï¼‰/DEBUGï¼ˆå¼€å‘ï¼‰
      - WORKERS=4  # Uvicornå·¥ä½œè¿›ç¨‹æ•°ï¼ˆæ¨è=CPUæ ¸å¿ƒæ•°ï¼Œå¦‚8æ ¸è®¾ä¸º8ï¼‰
      - TZ=Asia/Shanghai
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1  # ç”³è¯·1å—GPU
              capabilities: [gpu]  # å£°æ˜GPUèµ„æºï¼ˆéœ€å®‰è£…NVIDIA Docker Runtimeï¼‰
    networks:
      - lazyllm-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 15s
      timeout: 5s
      retries: 3

  # 3. Prometheusç›‘æ§æœåŠ¡ï¼ˆæ”¶é›†æŒ‡æ ‡ï¼šå“åº”æ—¶é—´ã€GPUä½¿ç”¨ç‡ã€ç¼“å­˜å‘½ä¸­ç‡ï¼‰
  prometheus:
    image: prom/prometheus:v2.45.0  # ç¨³å®šç‰ˆæœ¬ï¼ˆé¿å…å…¼å®¹æ€§é—®é¢˜ï¼‰
    container_name: lazyllm-prometheus
    ports:
      - "9090:9090"  # Prometheusç«¯å£
    volumes:
      - ./prometheus/prometheus.yml:/etc/prometheus/prometheus.yml  # ç›‘æ§é…ç½®
      - ./prometheus/data:/prometheus/data  # ç›‘æ§æ•°æ®æŒä¹…åŒ–
    restart: always
    networks:
      - lazyllm-network
    environment:
      - TZ=Asia/Shanghai
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.retention.time=30d'  # ç›‘æ§æ•°æ®ä¿ç•™30å¤©

  # 4. Grafanaå¯è§†åŒ–æœåŠ¡ï¼ˆç›‘æ§é¢æ¿ï¼šå¯è§†åŒ–æŒ‡æ ‡+å‘Šè­¦ï¼‰
  grafana:
    image: grafana/grafana:10.1.2  # ç¨³å®šç‰ˆæœ¬
    container_name: lazyllm-grafana
    ports:
      - "3000:3000"  # Grafanaç«¯å£
    volumes:
      - ./grafana/data:/var/lib/grafana  # Grafanaæ•°æ®æŒä¹…åŒ–ï¼ˆé¢æ¿é…ç½®ã€ç”¨æˆ·ä¿¡æ¯ï¼‰
      - ./grafana/dashboard.json:/etc/grafana/provisioning/dashboards/rag-dashboard.json  # é¢æ¿æ¨¡æ¿
      - ./grafana/provisioning.yaml:/etc/grafana/provisioning/datasources/prometheus.yaml  # æ•°æ®æºé…ç½®
    depends_on:
      - prometheus  # ä¾èµ–PrometheusæœåŠ¡
    restart: always
    networks:
      - lazyllm-network
    environment:
      - GF_SECURITY_ADMIN_PASSWORD=admin@2024  # ç®¡ç†å‘˜å¯†ç ï¼ˆç”Ÿäº§ç¯å¢ƒå»ºè®®ä¿®æ”¹ä¸ºå¤æ‚å¯†ç ï¼‰
      - GF_USERS_ALLOW_SIGN_UP=false  # ç¦ç”¨æ³¨å†Œï¼ˆå®‰å…¨ä¿éšœï¼‰
      - GF_USERS_ALLOW_ORG_CREATE=false  # ç¦ç”¨åˆ›å»ºç»„ç»‡
      - GF_DASHBOARDS_DEFAULT_HOME_DASHBOARD_PATH=/etc/grafana/provisioning/dashboards/rag-dashboard.json  # é»˜è®¤é¢æ¿
      - TZ=Asia/Shanghai
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/healthz"]
      interval: 15s
      timeout: 5s
      retries: 3

  # 5. ç¼“å­˜æ¸…ç†æœåŠ¡ï¼ˆå®šæ—¶æ¸…ç†è¿‡æœŸç¼“å­˜ï¼Œé¿å…Rediså†…å­˜æº¢å‡ºï¼‰
  cache-cleaner:
    image: redis:7.2-alpine
    container_name: lazyllm-cache-cleaner
    depends_on:
      - redis
    restart: always
    networks:
      - lazyllm-network
    environment:
      - TZ=Asia/Shanghai
    command: sh -c "while true; do redis-cli -h redis -p 6379 FLUSHDB; echo 'ğŸ“… ç¼“å­˜æ¸…ç†å®Œæˆï¼ˆæ¯å¤©ä¸€æ¬¡ï¼‰'; sleep 86400; done"  # æ¯å¤©æ¸…ç†ä¸€æ¬¡
